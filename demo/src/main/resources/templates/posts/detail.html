<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">ê²Œì‹œê¸€</title>
</head>

<body th:data-post-id="${post.id}">

<h2 th:text="${post.title}"></h2>

<p>
    ì‘ì„±ì: <span th:text="${post.user.username}"></span> |
    ì‘ì„±ì¼:
    <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
</p>

<hr>

<div th:text="${post.content}"></div>

<hr>

<!-- ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ -->
<div th:if="${loginUser != null}">
    <th:block th:if="${loginUser.username == post.user.username}">
        <a th:href="@{|/posts/${post.id}/edit|}">ìˆ˜ì •</a>

        <form th:action="@{|/posts/${post.id}/delete|}"
              method="post"
              style="display:inline;"
              onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            <button type="submit">ì‚­ì œ</button>
        </form>
    </th:block>
</div>

<hr>

<h3>ëŒ“ê¸€</h3>

<!-- ëŒ“ê¸€ ì‘ì„± -->
<div th:if="${loginUser != null}">
    <form id="comment-form">
        <textarea id="comment-content"
                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                  required></textarea>
        <br>
        <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
</div>

<div th:if="${loginUser == null}">
    <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
</div>

<hr>

<!-- ğŸ”¥ ëŒ“ê¸€ ëª©ë¡ ì˜ì—­ -->
<div id="comment-list"></div>

<hr>

<a th:href="@{/posts}">ëª©ë¡</a>

<script>
    // postId ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
    const postId = document.body.dataset.postId;

    function loadComments() {
        fetch(`/api/posts/${postId}/comments`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById("comment-list");
                list.innerHTML = "";

                data.forEach(comment => {
                    let deleteBtn = "";
                    if (comment.mine) {
                        deleteBtn = `<button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>`;
                    }

                    const div = document.createElement("div");
                    div.innerHTML = `
                        <p>
                            <b>${comment.username}</b> :
                            ${comment.content}
                            <small>(${comment.createdAt})</small>
                            ${deleteBtn}
                        </p>
                    `;
                    list.appendChild(div);
                });
            });
    }

    // ëŒ“ê¸€ ì‘ì„±
    document.getElementById("comment-form")?.addEventListener("submit", function (e) {
        e.preventDefault();

        const content = document.getElementById("comment-content").value;

        fetch(`/api/posts/${postId}/comments`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ content })
        }).then(res => {
            if (res.ok) {
                document.getElementById("comment-content").value = "";
                loadComments();
            } else {
                alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
            }
        });
    });

    // ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(commentId) {
        fetch(`/api/comments/${commentId}`, {
            method: "DELETE"
        }).then(res => {
            if (res.ok) {
                loadComments();
            } else {
                alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
            }
        });
    }

    // ìµœì´ˆ ë¡œë”©
    loadComments();
</script>

</body>
</html>
